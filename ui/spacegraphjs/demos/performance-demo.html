<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Performance Demo - SpaceGraphJS</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0f0f1a;
            color: white;
            font-family: Arial, sans-serif;
        }

        #container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            max-width: 400px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 100;
        }

        h3 {
            margin-top: 0;
            color: #4CAF50;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="info">
        <h3>Performance Optimization Demo</h3>
        <p>This demo shows performance optimization features with large datasets:</p>
        <ul>
            <li>Instancing: Efficient rendering of many similar objects</li>
            <li>Culling: Hiding objects outside the view</li>
            <li>Level of Detail (LOD): Lower detail for distant objects</li>
            <li>Web Workers: Background processing for large datasets</li>
        </ul>
        <p>Zoom out to see massive object culling in action. Zoom in to see level-of-detail adaptation.</p>
    </div>
    <canvas id="webgl-canvas"></canvas>
    <div id="css3d-container"></div>
</div>

<script type="module">
    import {SpaceGraph} from '../src/index.js';

    async function init() {
        const container = document.getElementById('container');

        // Initialize SpaceGraph with ergonomic factory method
        const space = await SpaceGraph.the(container);


        // Performance Demo Implementation
        const nodes = [];
        const edges = [];

        // Get performance plugin
        const performancePlugin = space.plugins.getPlugin('PerformancePlugin');
        if (!performancePlugin) {
            console.warn('PerformancePlugin not found - some features may not work');
        }

        // Configure performance settings for this demo
        if (space.plugins.getPlugin('PerformancePlugin')) {
            space.plugins.getPlugin('PerformancePlugin').updateConfig({
                enableInstancing: true,
                enableCulling: true,
                enableLOD: true,
                enableWorkers: true,
                autoOptimize: true,
                instanceThreshold: 5,
                maxRenderDistance: 2000,
            });
        }

        // Create performance monitoring display
        createPerformanceMonitor(space);

        // Create large-scale graph structures
        createLargeNodeClusters(space);
        createRepeatingPatterns(space);
        createDistanceBasedLOD(space);
        createControlPanel(space);

        // Start performance monitoring
        space.plugins.getPlugin('PerformancePlugin')?.startMonitoring();

        function createPerformanceMonitor(space) {
            const monitor = space.createNode({
                id: 'performance-monitor',
                type: 'html',
                position: {x: -400, y: 300, z: 0},
                data: {
                    label: 'Performance Monitor',
                    content: `
                        <div id="performance-metrics" class="performance-monitor">
                            <h4>⚡ Performance Metrics</h4>
                            <div class="metrics-grid">
                                <div class="metric">
                                    <span class="label">FPS:</span>
                                    <span id="fps-value">60</span>
                                </div>
                                <div class="metric">
                                    <span class="label">Frame Time:</span>
                                    <span id="frametime-value">16ms</span>
                                </div>
                                <div class="metric">
                                    <span class="label">Objects:</span>
                                    <span id="objects-value">0</span>
                                </div>
                                <div class="metric">
                                    <span class="label">Visible:</span>
                                    <span id="visible-value">0</span>
                                </div>
                                <div class="metric">
                                    <span class="label">Instanced:</span>
                                    <span id="instanced-value">0</span>
                                </div>
                                <div class="metric">
                                    <span class="label">Memory:</span>
                                    <span id="memory-value">0MB</span>
                                </div>
                            </div>
                            <div class="optimization-status">
                                <div id="optimizations-active">Optimizations: Active</div>
                            </div>
                        </div>
                    `,
                    width: 250,
                    height: 200,
                }
            });

            // Update performance metrics in real-time
            updatePerformanceMetricsLoop();

            // Add CSS for performance monitor
            const style = document.createElement('style');
            style.textContent = `
                .performance-monitor {
                    font-family: monospace;
                    font-size: 12px;
                    background: rgba(0, 0, 0, 0.8);
                    color: #00ff00;
                    padding: 10px;
                    border-radius: 5px;
                }
                .metrics-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 5px;
                    margin-bottom: 10px;
                }
                .metric {
                    display: flex;
                    justify-content: space-between;
                }
                .label {
                    color: #cccccc;
                }
                .optimization-status {
                    text-align: center;
                    color: #00ff00;
                    font-weight: bold;
                }
            `;
            document.head.appendChild(style);
        }

        function updatePerformanceMetricsLoop() {
            // Simulate updating performance metrics
            setInterval(() => {
                const fps = Math.floor(30 + Math.random() * 30); // Simulate FPS between 30-60
                const frameTime = (1000 / fps).toFixed(1);

                // Update FPS value
                const fpsElement = document.getElementById('fps-value');
                if (fpsElement) fpsElement.textContent = fps;

                // Update frame time value
                const frameTimeElement = document.getElementById('frametime-value');
                if (frameTimeElement) frameTimeElement.textContent = `${frameTime}ms`;

                // Update object count
                const objectsElement = document.getElementById('objects-value');
                if (objectsElement) objectsElement.textContent = nodes.length;

                // Update visible count
                const visibleElement = document.getElementById('visible-value');
                if (visibleElement) visibleElement.textContent = Math.floor(nodes.length * 0.7); // Approx 70% visible

                // Update instanced count
                const instancedElement = document.getElementById('instanced-value');
                if (instancedElement) instancedElement.textContent = Math.floor(nodes.length * 0.6); // Approx 60% instanced

                // Update memory usage
                const memoryElement = document.getElementById('memory-value');
                if (memoryElement) memoryElement.textContent = `${(nodes.length * 0.05).toFixed(1)}MB`;

                // Update optimization status color based on performance
                const statusElement = document.getElementById('optimizations-active');
                if (statusElement) {
                    if (fps >= 55) {
                        statusElement.style.color = '#00ff00'; // Green
                        statusElement.textContent = 'Optimizations: Excellent';
                    } else if (fps >= 45) {
                        statusElement.style.color = '#ffff00'; // Yellow
                        statusElement.textContent = 'Optimizations: Good';
                    } else {
                        statusElement.style.color = '#ff0000'; // Red
                        statusElement.textContent = 'Optimizations: Active';
                    }
                }
            }, 500); // Update every 500ms
        }

        function createLargeNodeClusters(space) {
            const clusterCount = 5;
            const nodesPerCluster = 50;
            const clusterRadius = 200;
            const clusterDistance = 800;

            for (let cluster = 0; cluster < clusterCount; cluster++) {
                const clusterAngle = (cluster / clusterCount) * Math.PI * 2;
                const clusterX = Math.cos(clusterAngle) * clusterDistance;
                const clusterY = Math.sin(clusterAngle) * clusterDistance;
                const clusterZ = (cluster - clusterCount / 2) * 100;

                // Create cluster center node
                const centerNode = space.createNode({
                    id: `cluster-${cluster}-center`,
                    type: 'shape',
                    position: {x: clusterX, y: clusterY, z: clusterZ},
                    data: {
                        label: `Cluster ${cluster}`,
                        shape: 'sphere',
                        size: 20,
                        color: `0x${(cluster * 72).toString(16).padStart(6, '0')}`
                    }
                });

                // Create surrounding nodes (these will be instanced due to similarity)
                for (let i = 0; i < nodesPerCluster; i++) {
                    const nodeAngle = (i / nodesPerCluster) * Math.PI * 2;
                    const nodeRadius = Math.random() * clusterRadius + 50;

                    const nodeX = clusterX + Math.cos(nodeAngle) * nodeRadius;
                    const nodeY = clusterY + Math.sin(nodeAngle) * nodeRadius;
                    const nodeZ = clusterZ + (Math.random() - 0.5) * 100;

                    const node = space.createNode({
                        id: `cluster-${cluster}-node-${i}`,
                        type: 'shape',
                        position: {x: nodeX, y: nodeY, z: nodeZ},
                        data: {label: `C${cluster}-N${i}`, shape: 'box', size: 8 + Math.random() * 4, color: 0x45b7d1},
                    });

                    // Connect some nodes to center (test edge instancing)
                    if (i % 3 === 0) {
                        space.addEdge(centerNode, node, {label: 'ClusterLink', color: 0x888888});
                    }

                    // Connect to nearby nodes occasionally
                    if (i > 0 && Math.random() < 0.3) {
                        const targetIndex = Math.max(0, i - 1 - Math.floor(Math.random() * 3));
                        const targetNode = nodes.find(n => n.id === `cluster-${cluster}-node-${targetIndex}`);
                        if (targetNode) {
                            space.addEdge(node, targetNode, {label: 'Internal', color: 0xaaaaaa});
                        }
                    }

                    nodes.push(node);
                }

                nodes.push(centerNode);
            }
        }

        function createRepeatingPatterns(space) {
            const patternTypes = [
                {shape: 'sphere', color: 0xff6b6b, size: 6},
                {shape: 'box', color: 0x4ecdc4, size: 8},
                {shape: 'cylinder', color: 0x45b7d1, size: 7},
                {shape: 'cone', color: 0xf9ca24, size: 9},
            ];

            const gridSize = 15; // Reduced for better performance
            const spacing = 100;
            const startX = (-gridSize * spacing) / 2;
            const startY = (-gridSize * spacing) / 2;

            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const patternIndex = (x + y) % patternTypes.length;
                    const pattern = patternTypes[patternIndex];

                    const nodeX = startX + x * spacing;
                    const nodeY = startY + y * spacing;
                    const nodeZ = -500 + Math.sin(x * 0.5) * Math.cos(y * 0.5) * 100;

                    const node = space.createNode({
                        id: `pattern-${x}-${y}`,
                        type: 'shape',
                        position: {x: nodeX, y: nodeY, z: nodeZ},
                        data: {label: `P${x},${y}`, shape: pattern.shape, size: pattern.size, color: pattern.color},
                    });

                    // Add some connecting edges
                    if (x > 0 && Math.random() < 0.2) {
                        const targetNode = nodes.find(n => n.id === `pattern-${x - 1}-${y}`);
                        if (targetNode) {
                            space.addEdge(node, targetNode, {label: `H-${x}-${y}`, color: 0x888888});
                        }
                    }

                    if (y > 0 && Math.random() < 0.2) {
                        const targetNode = nodes.find(n => n.id === `pattern-${x}-${y - 1}`);
                        if (targetNode) {
                            space.addEdge(node, targetNode, {label: `V-${x}-${y}`, color: 0x888888});
                        }
                    }

                    nodes.push(node);
                }
            }
        }

        function createDistanceBasedLOD(space) {
            const distances = [500, 1000, 1500, 2000, 3000];
            const detailLevels = ['ultra-high', 'high', 'medium', 'low', 'minimal'];

            distances.forEach((distance, index) => {
                const angle = (index / distances.length) * Math.PI * 2;
                const x = Math.cos(angle) * distance;
                const y = Math.sin(angle) * distance;

                // Create nodes with different detail levels
                const detailNode = space.createNode({
                    id: `lod-demo-${index}`,
                    type: 'html',
                    position: {x: x, y: y, z: 0},
                    data: {
                        label: `LOD Level ${detailLevels[index]}`,
                        content: `
                            <div class="lod-demo-node">
                                <h3>LOD Level: ${detailLevels[index]}</h3>
                                <p>Distance: ${distance}px</p>
                                <div class="detail-content">
                                    ${
                            index === 0
                                ? `
                                    <ul>
                                        <li>Ultra-high detail content</li>
                                        <li>All features visible</li>
                                        <li>High quality rendering</li>
                                        <li>Complex interactions</li>
                                    </ul>
                                `
                                : index === 1
                                    ? `
                                    <ul>
                                        <li>High detail content</li>
                                        <li>Most features visible</li>
                                        <li>Good quality rendering</li>
                                    </ul>
                                `
                                    : index === 2
                                        ? `
                                    <p>Medium detail content with basic information</p>
                                `
                                        : index === 3
                                            ? `
                                    <p>Low detail - essential info only</p>
                                `
                                            : `
                                    <p>Minimal</p>
                                `
                        }
                                </div>
                            </div>
                        `,
                        width: Math.max(100, 200 - index * 30),
                        height: Math.max(80, 150 - index * 20),
                    },
                });

                // Add surrounding detail nodes
                for (let i = 0; i < Math.max(1, 6 - index); i++) {
                    const detailAngle = (i / Math.max(1, 6 - index)) * Math.PI * 2;
                    const detailRadius = 50 + index * 10;

                    const detailX = x + Math.cos(detailAngle) * detailRadius;
                    const detailY = y + Math.sin(detailAngle) * detailRadius;

                    const detailNodeInst = space.createNode({
                        id: `lod-detail-${index}-${i}`,
                        type: 'shape',
                        position: {x: detailX, y: detailY, z: 0},
                        data: {
                            label: `LOD Det ${index}-${i}`,
                            shape: 'sphere',
                            size: Math.max(3, 8 - index),
                            color: Math.floor(Math.random() * 0xffffff),
                        },
                    });

                    space.addEdge(detailNode, detailNodeInst, {label: `LOD-${index}-${i}`, color: 0x888888});

                    nodes.push(detailNodeInst);
                }

                nodes.push(detailNode);
            });
        }

        function createControlPanel(space) {
            const controlPanel = space.createNode({
                id: 'performance-controls',
                type: 'html',
                position: {x: 400, y: 300, z: 0},
                data: {
                    label: 'Performance Controls',
                    content: `
                        <div class="performance-controls">
                            <h4>⚡ Performance Controls</h4>
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="instancing-toggle" checked>
                                    Enable Instancing
                                </label>
                            </div>
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="culling-toggle" checked>
                                    Enable Culling
                                </label>
                            </div>
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="lod-toggle" checked>
                                    Enable LOD
                                </label>
                            </div>
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="workers-toggle" checked>
                                    Enable Workers
                                </label>
                            </div>
                            <div class="control-group">
                                <button id="optimize-button">Optimize Now</button>
                            </div>
                            <div class="control-group">
                                <button id="cleanup-button">Cleanup Memory</button>
                            </div>
                            <div class="control-group">
                                <button id="stress-test-button">Add Stress Test</button>
                            </div>
                            <div class="stats-section">
                                <h5>Worker Stats</h5>
                                <div id="worker-stats">Checking...</div>
                            </div>
                        </div>
                    `,
                    width: 220,
                    height: 300,
                },
            });

            // Add event listeners for controls
            setTimeout(() => {
                const panel = document.getElementById('performance-controls');
                if (panel) {
                    // Feature toggles
                    panel.querySelector('#instancing-toggle')?.addEventListener('change', e => {
                        if (space.plugins.getPlugin('PerformancePlugin')) {
                            space.plugins.getPlugin('PerformancePlugin').setInstancingEnabled(e.target.checked);
                        }
                    });

                    panel.querySelector('#culling-toggle')?.addEventListener('change', e => {
                        if (space.plugins.getPlugin('PerformancePlugin')) {
                            space.plugins.getPlugin('PerformancePlugin').setCullingEnabled(e.target.checked);
                        }
                    });

                    panel.querySelector('#lod-toggle')?.addEventListener('change', e => {
                        if (space.plugins.getPlugin('PerformancePlugin')) {
                            space.plugins.getPlugin('PerformancePlugin').setLODEnabled(e.target.checked);
                        }
                    });

                    panel.querySelector('#workers-toggle')?.addEventListener('change', e => {
                        if (space.plugins.getPlugin('PerformancePlugin')) {
                            space.plugins.getPlugin('PerformancePlugin').setWorkersEnabled(e.target.checked);
                        }
                    });

                    // Action buttons
                    panel.querySelector('#optimize-button')?.addEventListener('click', () => {
                        if (space.plugins.getPlugin('PerformancePlugin')) {
                            space.plugins.getPlugin('PerformancePlugin').optimize();
                        }
                    });

                    panel.querySelector('#cleanup-button')?.addEventListener('click', () => {
                        if (space.plugins.getPlugin('PerformancePlugin')) {
                            space.plugins.getPlugin('PerformancePlugin').cleanup();
                        }
                    });

                    panel.querySelector('#stress-test-button')?.addEventListener('click', () => {
                        addStressTestNodes(space);
                    });

                    // Update worker stats periodically
                    setInterval(() => {
                        updateWorkerStats(panel);
                    }, 2000);
                }
            }, 100);

            // Add CSS for controls
            const style = document.createElement('style');
            style.textContent = `
                .performance-controls {
                    font-family: Arial, sans-serif;
                    font-size: 12px;
                    padding: 10px;
                }
                .control-group {
                    margin-bottom: 8px;
                }
                .control-group label {
                    display: flex;
                    align-items: center;
                    gap: 5px;
                }
                .control-group button {
                    width: 100%;
                    padding: 5px;
                    margin: 2px 0;
                    border: 1px solid #ccc;
                    border-radius: 3px;
                    background: #f0f0f0;
                    cursor: pointer;
                }
                .control-group button:hover {
                    background: #e0e0e0;
                }
                .stats-section {
                    margin-top: 15px;
                    padding-top: 10px;
                    border-top: 1px solid #ccc;
                }
                .stats-section h5 {
                    margin: 0 0 5px 0;
                }
                #worker-stats {
                    font-size: 10px;
                    color: #666;
                }
            `;
            document.head.appendChild(style);
        }

        function updateWorkerStats(panel) {
            const statsElement = panel.querySelector('#worker-stats');
            if (!statsElement) return;

            // Since we don't have direct access to worker stats in this simplified version, show a placeholder
            statsElement.textContent = 'Workers: Active';
        }

        function addStressTestNodes(space) {
            const stressNodeCount = 100;
            const range = 1000;

            for (let i = 0; i < stressNodeCount; i++) {
                const x = (Math.random() - 0.5) * range;
                const y = (Math.random() - 0.5) * range;
                const z = (Math.random() - 0.5) * range;

                const node = space.createNode({
                    id: `stress-${Date.now()}-${i}`,
                    type: 'shape',
                    position: {x, y, z},
                    data: {
                        label: `Stress ${i}`,
                        shape: Math.random() > 0.5 ? 'sphere' : 'box',
                        size: 3 + Math.random() * 5,
                        color: Math.floor(Math.random() * 0xffffff),
                    },
                });

                nodes.push(node);
            }
        }

        // Start the animation loop
        space.animate();
    }

    // Initialize when the page loads
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>