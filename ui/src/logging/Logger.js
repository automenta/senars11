import { UI_CONSTANTS } from '@senars/core';
import { LogViewer } from '../components/LogViewer.js';

export class Logger {
    constructor(uiElements = null) {
        this.uiElements = uiElements;
        this.logViewer = null;
        uiElements?.logsContainer && (this.logViewer = new LogViewer(uiElements.logsContainer));
        this.messageCounter = 1;
        this.icons = {
            success: UI_CONSTANTS.LOG_ICONS.SUCCESS,
            error: UI_CONSTANTS.LOG_ICONS.ERROR,
            warning: UI_CONSTANTS.LOG_ICONS.WARNING,
            info: UI_CONSTANTS.LOG_ICONS.INFO,
            debug: UI_CONSTANTS.LOG_ICONS.DEBUG,
            input: UI_CONSTANTS.LOG_ICONS.INPUT,
            task: UI_CONSTANTS.LOG_ICONS.TASK,
            concept: UI_CONSTANTS.LOG_ICONS.CONCEPT,
            question: UI_CONSTANTS.LOG_ICONS.QUESTION,
            reasoning: UI_CONSTANTS.LOG_ICONS.REASONING,
            connection: UI_CONSTANTS.LOG_ICONS.CONNECTION,
            snapshot: UI_CONSTANTS.LOG_ICONS.SNAPSHOT,
            control: UI_CONSTANTS.LOG_ICONS.CONTROL,
            notification: UI_CONSTANTS.LOG_ICONS.NOTIFICATION,
            command: UI_CONSTANTS.LOG_ICONS.COMMAND,
            demo: UI_CONSTANTS.LOG_ICONS.DEMO,
            refresh: UI_CONSTANTS.LOG_ICONS.REFRESH,
            clear: UI_CONSTANTS.LOG_ICONS.CLEAR,
            eventBatch: UI_CONSTANTS.LOG_ICONS.EVENT_BATCH
        };
    }

    setUIElements(uiElements) {
        this.uiElements = uiElements;
        uiElements?.logsContainer && (this.logViewer = new LogViewer(uiElements.logsContainer));
    }


    addLogEntry(content, type = 'info', icon = null) {
        if (this.logViewer) return this.logViewer.addLog(content, type, icon);

        const effectiveIcon = icon ?? this.icons[type] ?? this.icons[UI_CONSTANTS.LOG_TYPES.INFO];
        const timestamp = new Date().toLocaleTimeString();
        console.log(`[${timestamp}] ${effectiveIcon} ${content}`);
        return null;
    }

    log(content, type = 'info', icon = null) {
        this.addLogEntry(content, type, icon);
    }


    showNotification(message, type = 'info') {
        const container = this.uiElements?.notificationContainer ?? document.getElementById('notification-container');
        if (!container) {
            console[type === 'error' ? 'error' : type === 'warning' ? 'warn' : 'log'](message);
            return;
        }

        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        container.appendChild(notification);

        setTimeout(() => notification.parentNode?.removeChild(notification), 5000);
    }


    clearLogs() {
        if (this.logViewer) {
            this.logViewer.clear();
        } else if (this.uiElements?.logsContainer) {
            try {
                this.uiElements.logsContainer.innerHTML = '';
            } catch (e) {
                console.error('[Logger] Error clearing logs:', e);
            }
        } else {
            console.error('[Logger] Cannot clear logs: logsContainer not found');
            return;
        }
        this.log('Cleared logs', 'info', 'ðŸ§¹');
    }
}