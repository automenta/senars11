#!/usr/bin/env node

import path from 'path';
import {fileURLToPath} from 'url';
import {getFreePort} from './utils/network-utils.js';
import {TOURS} from './utils/tour-config.js';
import {TourRunner} from './utils/tour-runner.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.resolve(__dirname, '..');

const args = process.argv.slice(2);
const parallel = args.includes('--parallel') || args.includes('-p');
const timedMode = args.includes('--timed') || args.includes('--time');
const logOnlyMode = args.includes('--log-only') || args.includes('-l');
const movieMode = args.includes('--movie');
const graphMode = args.includes('--graph');

async function main() {
    const specified = args.filter(a => !a.startsWith('-'));
    const toursToRun = specified.length ? TOURS.filter(t => specified.includes(t.id)) : TOURS;

    if (toursToRun.length === 0) {
        console.error('No matching tours found.');
        process.exit(1);
    }

    const runner = new TourRunner({
        rootDir,
        logOnlyMode,
        movieMode,
        graphMode,
        timedMode
    });

    const runningProcesses = new Set();
    const trackProcess = (proc) => {
        runningProcesses.add(proc);
        proc.on('exit', () => runningProcesses.delete(proc));
    };

    process.on('SIGINT', () => {
        console.log('\nReceived SIGINT. Killing child processes...');
        runningProcesses.forEach(p => p.kill());
        process.exit();
    });

    if (parallel) {
        const promises = [];
        let basePort = 3000;

        for (const tour of toursToRun) {
            // Assign unique ports for each tour
            const uiPort = await getFreePort(basePort);
            const wsPort = await getFreePort(uiPort + 1);
            basePort = wsPort + 1;

            promises.push(
                runner.run(tour, uiPort, wsPort, trackProcess)
                    .catch(e => console.error(`Error in tour ${tour.id}:`, e))
            );
        }
        await Promise.all(promises);
    } else {
        for (const tour of toursToRun) {
            const uiPort = await getFreePort(5173);
            const wsPort = await getFreePort(8080);
            try {
                await runner.run(tour, uiPort, wsPort, trackProcess);
            } catch (e) {
                console.error(`Error in tour ${tour.id}:`, e);
            }
        }
    }
    console.log('Done.');
}

main().catch(err => {
    console.error('Unhandled error:', err);
    process.exit(1);
});
